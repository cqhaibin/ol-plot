!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("ol"),require("ol/interaction"),require("ol/style"),require("ol/Feature"),require("ol/interaction/Draw"),require("ol/layer"),require("ol/source"),require("ol/geom"),require("ol/geom/Polygon"),require("ol/extent.js"),require("ol/color"),require("ol/extent")):"function"==typeof define&&define.amd?define(["ol","ol/interaction","ol/style","ol/Feature","ol/interaction/Draw","ol/layer","ol/source","ol/geom","ol/geom/Polygon","ol/extent.js","ol/color","ol/extent"],e):(t=t||self).olPlot=e(t.ol,t.interaction,t.style,t.Feature,t.Draw,t.layer,t.source,t.geom,t.Polygon$1,t.extent_js,t.color,t.extent)}(this,function(l,o,u,c,n,s,p,g,r,a,f,d){"use strict";function t(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function h(t,e){t.prototype=Object.create(e.prototype),(t.prototype.constructor=t).__proto__=e}function v(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}c=c&&c.hasOwnProperty("default")?c.default:c;function m(){this.Events={},this.__cnt=0}m.hasOwnKey=Function.call.bind(Object.hasOwnProperty),m.slice=Function.call.bind(Array.prototype.slice),m.prototype.on=function(t,e,n){return this.bindEvent(t,e,0,n)},m.prototype.un=function(i){var t="",e="",o=!1,n=typeof i,r=this;return"string"==n?!!m.hasOwnKey(this.Events,i)&&(delete this.Events[i],!0):"object"==n?(t=i[0],e=i[1],!(!m.hasOwnKey(this.Events,t)||!m.hasOwnKey(this.Events[t],e))&&(delete this.Events[t][e],!0)):"function"!=n||(r.eachEvent(r.Events,function(n,t){r.eachEvent(t,function(t,e){e[0]===i&&(delete r.Events[n][t],o=!0)})}),o)},m.prototype.once=function(t,e,n){return this.bindEvent(t,e,1,n)},m.prototype.action=function(n,i){m.hasOwnKey(this.Events,n)&&this.eachEvent(this.Events[n],function(t,e){e[0].apply(e[2],i),e[1]&&delete this.Events[n][t]})},m.prototype.dispatch=function(t){var e=this,n=m.slice(arguments,1);setTimeout(function(){e.action(t,n)})},m.prototype.dispatchSync=function(t){this.action(t,m.slice(arguments,1))},m.prototype.clear=function(){this.Events={}},m.prototype.bindEvent=function(t,e,n,i){if("string"!=typeof t||"function"!=typeof e)throw new Error("传入的事件名称和回调函数有误！");return m.hasOwnKey(this.Events,t)||(this.Events[t]={}),this.Events[t][++this.__cnt]=[e,n,i],[t,this.__cnt]},m.prototype.eachEvent=function(t,e){for(var n in t)m.hasOwnKey(t,n)&&e(n,t[n])};function C(t,e){return Math.sqrt(Math.pow(t[0]-e[0],2)+Math.pow(t[1]-e[1],2))}function P(n){var i=0;return n&&Array.isArray(n)&&0<n.length&&n.forEach(function(t,e){e<n.length-1&&(i+=C(t,n[e+1]))}),i}function y(t){return Math.pow(P(t),.99)}function A(t,e){return[(t[0]+e[0])/2,(t[1]+e[1])/2]}function w(t,e,n){var i=[(t[0]+e[0])/2,(t[1]+e[1])/2],o=[i[0]-t[1]+e[1],i[1]+t[0]-e[0]],r=[(t[0]+n[0])/2,(t[1]+n[1])/2],s=[r[0]-t[1]+n[1],r[1]+t[0]-n[0]];return B(i,o,r,s)}function M(t,e){var n,i=Math.asin(Math.abs(e[1]-t[1])/C(t,e));return e[1]>=t[1]&&e[0]>=t[0]?n=i+Math.PI:e[1]>=t[1]&&e[0]<t[0]?n=2*Math.PI-i:e[1]<t[1]&&e[0]<t[0]?n=i:e[1]<t[1]&&e[0]>=t[0]&&(n=Math.PI-i),n}function x(t,e,n){var i=M(e,t)-M(e,n);return i<0?i+2*Math.PI:i}function E(t,e,n){return(n[1]-t[1])*(e[0]-t[0])>(e[1]-t[1])*(n[0]-t[0])}function T(t,e,n,i,o){var r=1-(t=Math.max(Math.min(t,1),0)),s=t*t,a=s*t,h=r*r,l=h*r;return[l*e[0]+3*h*t*n[0]+3*r*s*i[0]+a*o[0],l*e[1]+3*h*t*n[1]+3*r*s*i[1]+a*o[1]]}function b(t,e,n,i,o){var r=M(t,e),s=o?r+n:r-n,a=i*Math.cos(s),h=i*Math.sin(s);return[e[0]+a,e[1]+h]}function F(t,e,n,i){var o=null,r=null,s=[],a=i-n;a=a<0?a+2*Math.PI:a;for(var h=0;h<=100;h++){var l=n+a*h/100;o=t[0]+e*Math.cos(l),r=t[1]+e*Math.sin(l),s.push([o,r])}return s}function _(t,e,n,i){var o=V(e,n,i),r=null,s=null,a=null,h=Math.sqrt(o[0]*o[0]+o[1]*o[1]),l=o[0]/h,u=o[1]/h,c=C(e,n),p=C(n,i);return s=O<h?E(e,n,i)?(a=t*c,r=[n[0]-a*u,n[1]+a*l],a=t*p,[n[0]+a*u,n[1]-a*l]):(a=t*c,r=[n[0]+a*u,n[1]-a*l],a=t*p,[n[0]-a*u,n[1]+a*l]):(r=[n[0]+t*(e[0]-n[0]),n[1]+t*(e[1]-n[1])],[n[0]+t*(i[0]-n[0]),n[1]+t*(i[1]-n[1])]),[r,s]}function i(t,e){for(var n=null,i=null,o=[function(t,e){var n=[t[0],t[1],t[2],null,null],i=n[0],o=n[1],r=n[2],s=n[3],a=n[4],h=_(0,i,o,r)[0],l=V(i,o,r),u=Math.sqrt(l[0]*l[0]+l[1]*l[1]);if(O<u){var c=A(i,o),p=i[0]-c[0],g=i[1]-c[1],f=2/C(i,o),d=-f*g,v=f*p,m=d*d-v*v,P=2*d*v,y=v*v-d*d,w=h[0]-c[0],M=h[1]-c[1];s=c[0]+m*w+P*M,a=c[1]+P*w+y*M}else s=i[0]+e*(o[0]-i[0]),a=i[1]+e*(o[1]-i[1]);return[s,a]}(e,t)],r=[],s=0;s<e.length-2;s++){var a=[e[s],e[s+1],e[s+2]],h=_(t,n=a[0],i=a[1],a[2]);o=o.concat(h)}var l=function(t,e){var n=t.length,i=t[n-3],o=t[n-2],r=t[n-1],s=_(0,i,o,r)[1],a=V(i,o,r),h=Math.sqrt(a[0]*a[0]+a[1]*a[1]),l=null,u=null;if(O<h){var c=A(o,r),p=r[0]-c[0],g=r[1]-c[1],f=2/C(o,r),d=-f*g,v=f*p,m=d*d-v*v,P=2*d*v,y=v*v-d*d,w=s[0]-c[0],M=s[1]-c[1];l=c[0]+m*w+P*M,u=c[1]+P*w+y*M}else l=r[0]+e*(o[0]-r[0]),u=r[1]+e*(o[1]-r[1]);return[l,u]}(e,t);l&&o.push(l);for(var u=0;u<e.length-1;u++){n=e[u],i=e[u+1],r.push(n);for(var c=0;c<H;c++){var p=T(c/H,n,o[2*u],o[2*u+1],i);r.push(p)}r.push(i)}return r}function I(t){if(t.length<=2)return t;for(var e=[],n=t.length-1,i=0;i<=1;i+=.01){for(var o=0,r=0,s=0;s<=n;s++){var a=G(n,s),h=Math.pow(i,s),l=Math.pow(1-i,n-s);o+=a*h*l*t[s][0],r+=a*h*l*t[s][1]}e.push([o,r])}return e.push(t[n]),e}function k(t){var e=1;switch(t){case t<=1:e=1;break;case 2===t:e=2;break;case 3===t:e=6;break;case 24===t:e=24;break;case 5===t:e=120;break;default:for(var n=1;n<=t;n++)e*=n}return e}function D(t){if(t.length<=2)return t;var e=[],n=t.length-2-1;e.push(t[0]);for(var i=0;i<=n;i++)for(var o=0;o<=1;o+=.05){for(var r=0,s=0,a=0;a<=2;a++){var h=Y(a,o);r+=h*t[i+a][0],s+=h*t[i+a][1]}e.push([r,s])}return e.push(t[t.length-1]),e}function S(t){var e=typeof t;return null!==t&&("object"==e||"function"==e)}var H=100,L=Math.PI/2,O=1e-4,N=(Math.PI,"ol-plot-vector-layer"),R="plot-helper-control-point-div",W="plot-helper-hidden-div",z={borderRadius:"2px",fontSize:"12px",outline:0,overflow:"hidden",boxSizing:"border-box",border:"1px solid #eeeeee",fontFamily:"Helvetica Neue,Helvetica,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Noto Sans CJK SC,WenQuanYi Micro Hei,Arial,sans-serif",color:"#010500",fontWeight:400,padding:"3px",fontStretch:"normal",lineHeight:"normal",textAlign:"left",marginLeft:"auto",marginRight:"auto",width:"auto",height:"auto",background:"rgb(255, 255, 255)",fontStyle:"",fontVariant:""},B=function(t,e,n,i){if(t[1]===e[1])return[(i[0]-n[0])/(i[1]-n[1])*(t[1]-n[1])+n[0],t[1]];if(n[1]===i[1])return[(e[0]-t[0])/(e[1]-t[1])*(n[1]-t[1])+t[0],n[1]];var o=(e[0]-t[0])/(e[1]-t[1]),r=(i[0]-n[0])/(i[1]-n[1]),s=(o*t[1]-t[0]-r*n[1]+n[0])/(o-r);return[o*s-o*t[1]+t[0],s]},V=function(t,e,n){var i=t[0]-e[0],o=t[1]-e[1],r=Math.sqrt(i*i+o*o);i/=r,o/=r;var s=n[0]-e[0],a=n[1]-e[1],h=Math.sqrt(s*s+a*a);return[i+(s/=h),o+(a/=h)]},G=function(t,e){return k(t)/(k(e)*k(t-e))},Y=function(t,e){var n=0;return 0===t?n=Math.pow(e-1,2)/2:1===t?n=(-2*Math.pow(e,2)+2*e+1)/2:2===t&&(n=Math.pow(e,2)/2),n};function U(t,e){t.forEach(function(t){e[t]&&(e[t]=e[t].bind(e))})}function j(t,e){try{var n=null;if(t){var i=t.getLayers().getArray();n=X(i,"layerName",e)}return n}catch(t){console.log(t)}}function q(t,e,n){try{if(t){var i=j(t,e);if(i instanceof s.Vector||(i=null),i||n&&n.create&&(i=new s.Vector({layerName:e,params:n,layerType:"vector",source:new p.Vector({wrapX:!1}),style:new u.Style({fill:new u.Fill({color:"rgba(67, 110, 238, 0.4)"}),stroke:new u.Stroke({color:"#4781d9",width:2}),image:new u.Circle({radius:7,fill:new u.Fill({color:"#ffcc33"})})})})),t&&i){n&&n.hasOwnProperty("selectable")&&i.set("selectable",n.selectable);var o=j(t,e);o&&o instanceof s.Vector||t.addLayer(i)}return i}}catch(t){console.log(t)}}var X=function n(t,i,o){var r=null;return 0<t.length&&t.every(function(t){if(t instanceof s.Group){var e=t.getLayers().getArray();return!(r=n(e,i,o))}return t.get(i)!==o||(r=t,!1)}),r};"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self&&self;function Z(t){return"string"==typeof t?document.getElementById(t):t}var e,K=(function(t,e){!function(t,e){var u="function"==typeof Map?new Map:function(){var n=[],i=[];return{has:function(t){return-1<n.indexOf(t)},get:function(t){return i[n.indexOf(t)]},set:function(t,e){-1===n.indexOf(t)&&(n.push(t),i.push(e))},delete:function(t){var e=n.indexOf(t);-1<e&&(n.splice(e,1),i.splice(e,1))}}}(),c=function(t){return new Event(t,{bubbles:!0})};try{new Event("test")}catch(t){c=function(t){var e=document.createEvent("Event");return e.initEvent(t,!0,!1),e}}function n(o){if(o&&o.nodeName&&"TEXTAREA"===o.nodeName&&!u.has(o)){var n=null,i=null,r=null,t=function(){o.clientWidth!==i&&l()},s=function(e){window.removeEventListener("resize",t,!1),o.removeEventListener("input",l,!1),o.removeEventListener("keyup",l,!1),o.removeEventListener("autosize:destroy",s,!1),o.removeEventListener("autosize:update",l,!1),Object.keys(e).forEach(function(t){o.style[t]=e[t]}),u.delete(o)}.bind(o,{height:o.style.height,resize:o.style.resize,overflowY:o.style.overflowY,overflowX:o.style.overflowX,wordWrap:o.style.wordWrap});o.addEventListener("autosize:destroy",s,!1),"onpropertychange"in o&&"oninput"in o&&o.addEventListener("keyup",l,!1),window.addEventListener("resize",t,!1),o.addEventListener("input",l,!1),o.addEventListener("autosize:update",l,!1),o.style.overflowX="hidden",o.style.wordWrap="break-word",u.set(o,{destroy:s,update:l}),function(){var t=window.getComputedStyle(o,null);"vertical"===t.resize?o.style.resize="none":"both"===t.resize&&(o.style.resize="horizontal");n="content-box"===t.boxSizing?-(parseFloat(t.paddingTop)+parseFloat(t.paddingBottom)):parseFloat(t.borderTopWidth)+parseFloat(t.borderBottomWidth);isNaN(n)&&(n=0);l()}()}function a(t){var e=o.style.width;o.style.width="0px",o.offsetWidth,o.style.width=e,o.style.overflowY=t}function h(){if(0!==o.scrollHeight){var t=function(t){var e=[];for(;t&&t.parentNode&&t.parentNode instanceof Element;)t.parentNode.scrollTop&&e.push({node:t.parentNode,scrollTop:t.parentNode.scrollTop}),t=t.parentNode;return e}(o),e=document.documentElement&&document.documentElement.scrollTop;o.style.height="",o.style.height=o.scrollHeight+n+"px",i=o.clientWidth,t.forEach(function(t){t.node.scrollTop=t.scrollTop}),e&&(document.documentElement.scrollTop=e)}}function l(){h();var t=Math.round(parseFloat(o.style.height)),e=window.getComputedStyle(o,null),n="content-box"===e.boxSizing?Math.round(parseFloat(e.height)):o.offsetHeight;if(n<t?"hidden"===e.overflowY&&(a("scroll"),h(),n="content-box"===e.boxSizing?Math.round(parseFloat(window.getComputedStyle(o,null).height)):o.offsetHeight):"hidden"!==e.overflowY&&(a("hidden"),h(),n="content-box"===e.boxSizing?Math.round(parseFloat(window.getComputedStyle(o,null).height)):o.offsetHeight),r!==n){r=n;var i=c("autosize:resized");try{o.dispatchEvent(i)}catch(t){}}}}function i(t){var e=u.get(t);e&&e.destroy()}function o(t){var e=u.get(t);e&&e.update()}var r=null;"undefined"==typeof window||"function"!=typeof window.getComputedStyle?((r=function(t){return t}).destroy=function(t){return t},r.update=function(t){return t}):((r=function(t,e){return t&&Array.prototype.forEach.call(t.length?t:[t],function(t){return n(t)}),t}).destroy=function(t){return t&&Array.prototype.forEach.call(t.length?t:[t],i),t},r.update=function(t){return t&&Array.prototype.forEach.call(t.length?t:[t],o),t}),e.default=r,t.exports=e.default}(t,e)}(e={exports:{}},e.exports),e.exports),Q=/([\:\-\_]+(.))/g,J=/^moz([A-Z])/,$=function(t){return t.replace(Q,function(t,e,n,i){return i?n.toUpperCase():n}).replace(J,"Moz$1")},tt=function(){if(document.addEventListener)return function(t,e,n){t&&e&&n&&t.addEventListener(e,n,!1)}}(),et=function(){if(document.removeEventListener)return function(t,e,n){t&&e&&t.removeEventListener(e,n,!1)}}();function nt(e,n){if(!e||!n)return null;"float"===(n=$(n))&&(n="cssFloat");try{var t=document.defaultView.getComputedStyle(e,"");return e.style[n]||t?t[n]:null}catch(t){return e.style[n]}}function it(t,e,n){if(t&&e)if("object"==typeof e)for(var i in e)e.hasOwnProperty(i)&&it(t,i,e[i]);else"opacity"===(e=$(e))?t.style.filter=isNaN(n)?"":"alpha(opacity="+100*n+")":t.style[e]=n}var ot,rt=function(g){function t(t){var e;void 0===t&&(t={});var n=[t.id,t.element,t.offset,t.stopEvent,t.positioning,t.insertFirst,t.autoPan,t.autoPanAnimation,t.autoPanMargin,t.className?t.className:"ol-plot-text-editor"],i=n[0],o=n[1],r=n[2],s=n[3],a=n[4],h=n[5],l=n[6],u=n[7],c=n[8],p=n[9];return(e=g.call(this,{id:i,element:o,stopEvent:s,insertFirst:h,autoPan:l,autoPanAnimation:u,autoPanMargin:c,className:p})||this).setOffset(void 0!==r?r:[0,0]),e.setPositioning(void 0!==a?a:"center-center"),e.mapDragPan=void 0,e.isClick_=!1,e.dragging_=!1,e.isFocus_=!1,e.options_=t,e._position=t.position&&0<t.position.length?t.position:[],e.handleTimer_=null,e.currentPixel_=[],U(["handleFocus_","handleBlur_","handleClick_","handleDragStart_","handleDragEnd_","handleDragDrag_","closeCurrentPlotText","handleResizeMouseDown_","handleResizeMouseMove_","handleResizeMouseUp_","resizeButtonMoveHandler_"],v(e)),e.createTextContent(t),e}h(t,g);var e=t.prototype;return e.createTextContent=function(t){var e=t.className||"ol-plot-text-editor",n=document.createElement("textarea");n.className=e,n.style.width=t.width+"px",n.style.height=t.height+"px",n.style.minHeight=t.minHeight+"px",n.setAttribute("id",t.id),n.setAttribute("autofocus",!0),K(n),tt(n,"focus",this.handleFocus_),tt(n,"blur",this.handleBlur_),tt(n,"click",this.handleClick_),tt(n,"mousedown",this.handleDragStart_),tt(window,"mouseup",this.handleDragEnd_),this.set("isPlotText",!0),this.setElement(n),this.createCloseButton(t),this.createResizeButton(t),this.setPosition(this._position),this.dispatchEvent("textBoxDrawEnd",{overlay:this,element:n,uuid:t.id})},e.getTextAreaFromContent_=function(){var e="",t=Array.prototype.slice.call(this.element&&this.element.children,0);return 0<t.length&&t.every(function(t){return 1!==t.nodeType||"textarea"!==t.nodeName.toLowerCase()||(e=t,!1)}),e},e.createCloseButton=function(t){var e=document.createElement("span");e.className="ol-plot-text-editor-close",e.setAttribute("data-id",t.id),et(e,"click",this.closeCurrentPlotText),tt(e,"click",this.closeCurrentPlotText),this.element.appendChild(e)},e.createResizeButton=function(t){var e=document.createElement("span");e.className="ol-plot-text-editor-resize",e.setAttribute("data-id",t.id),et(e,"mousedown",this.handleResizeMouseDown_),et(e,"mousemove",this.handleResizeMouseMove_),tt(e,"mousedown",this.handleResizeMouseDown_),tt(e,"mousemove",this.handleResizeMouseMove_),this.element.appendChild(e)},e.resizeButtonMoveHandler_=function(t){var e=t.pixel,n=this.getTextAreaFromContent_();if(!(e.length<1||this.currentPixel_.length<1)&&n){var i=[e[0]-this.currentPixel_[0],e[1]-this.currentPixel_[1]],o=[n.offsetWidth,n.offsetHeight],r=o[1]+2*i[1];it(n,"width",o[0]+2*i[0]+"px"),it(n,"height",r+"px"),this.currentPixel_=e,this.getMap().render()}},e.handleResizeMouseMove_=function(t){t.stopImmediatePropagation()},e.handleResizeMouseDown_=function(t){this.getMap()&&(this.currentPixel_=[t.x,t.y],this.getMap().on("pointermove",this.resizeButtonMoveHandler_),tt(this.getMap().getViewport(),"mouseup",this.handleResizeMouseUp_))},e.handleResizeMouseUp_=function(t){this.getMap()&&(this.getMap().un("pointermove",this.resizeButtonMoveHandler_),et(this.getMap().getViewport(),"mouseup",this.handleResizeMouseUp_),this.currentPixel_=[])},e.closeCurrentPlotText=function(t){if(this.getMap()&&t&&function(t,e){if(!t||!e)return!1;if(-1!==e.indexOf(" "))throw new Error("className should not contain space.");return t.classList?t.classList.contains(e):-1<(" "+t.className+" ").indexOf(" "+e+" ")}(t.target,"ol-plot-text-editor-close")){var e=t.target.getAttribute("data-id");if(e){var n=this.getMap().getOverlayById(e);n&&this.getMap().removeOverlay(n)}}},e.handleFocus_=function(){this.isFocus_=!0,this.getMap()&&(this.getMap().set("activeTextArea",this),this.getMap().dispatchEvent("activeTextArea"))},e.handleBlur_=function(){this.isFocus_=!1,this.getMap()&&(this.getMap().set("activeTextArea",null),this.getMap().set("disActiveTextArea",this),this.getMap().dispatchEvent("disActiveTextArea"))},e.handleDragStart_=function(t){var e=this;this.getMap()&&!this.dragging_&&this.isMoveModel()&&this.isFocus_&&(this.handleTimer_=window.setTimeout(function(){window.clearTimeout(e.handleTimer_),e.handleTimer_=null,e.isClick_||(e.dragging_=!0,e.disableMapDragPan(),e.preCursor_=e.element.style.cursor,tt(e.getMap().getViewport(),"mousemove",e.handleDragDrag_),tt(e.element,"mouseup",e.handleDragEnd_))},300))},e.handleDragDrag_=function(t){this.dragging_&&(this.element.style.cursor="move",this._position=this.getMap().getCoordinateFromPixel([t.clientX,t.clientY]),this.setPosition(this._position))},e.handleDragEnd_=function(t){this.isClick_=!1,window.clearTimeout(this.handleTimer_),this.handleTimer_=null,this.dragging_&&this.isFocus_&&(this.dragging_=!1,this.enableMapDragPan(),this.element.style.cursor=this.preCursor_,et(this.getMap().getViewport(),"mousemove",this.handleDragDrag_),et(this.element,"mouseup",this.handleDragEnd_))},e.handleClick_=function(t){t.target===this.element?this.isClick_=!0:this.isClick_=!1},e.isMoveModel=function(){return window.getSelection().getRangeAt(0).collapsed},e.setStyle=function(t){void 0===t&&(t={});var e=this.getTextAreaFromContent_();if(e)for(var n in t)t[n]&&it(e,n,t[n])},e.getStyle=function(){var t={},e=this.getTextAreaFromContent_();if(e)for(var n in z)t[n]=nt(e,n);return t},e.setValue=function(t){var e=this.getTextAreaFromContent_();e&&((e.value=t)&&K.update(e),this.getMap().render())},e.getValue=function(){var t=this.getTextAreaFromContent_();return t?t.value:""},e.getWidth=function(){var t=this.getTextAreaFromContent_();return t&&t.offsetWidth?t.offsetWidth:0},e.getHeight=function(){var t=this.getTextAreaFromContent_();return t&&t.offsetHeight?t.offsetHeight:0},e.enableMapDragPan=function(){var t=this.getMap();t&&this.mapDragPan&&this.mapDragPan instanceof o.DragPan&&(t.addInteraction(this.mapDragPan),delete this.mapDragPan)},e.disableMapDragPan=function(){var e=this,n=this.getMap();n&&n.getInteractions().getArray().every(function(t){return!(t instanceof o.DragPan)||(e.mapDragPan=t,n.removeInteraction(t),!1)})},e.setMap=function(t){g.prototype.setMap.call(this,t),t&&t instanceof l.Map&&(this.setStyle(function t(e,n){for(var i in n)S(n[i])&&S(e[i])?t(e[i],n[i]):e[i]=n[i];return e}(z,this.options_.style)),this.setValue(this.options_.value))},t}(l.Overlay),st="TextArea",at="Curve",ht="GatheringPlace",lt="Polyline",ut="FreeHandLine",ct="Point",pt="Pennant",gt="RectAngle",ft="Circle",dt="Ellipse",vt="Lune",mt="Sector",Pt="ClosedCurve",yt="Polygon",wt="FreePolygon",Mt="AttackArrow",Ct="DoubleArrow",At="StraightArrow",xt="FineArrow",Et="AssaultDirection",Tt="TailedAttackArrow",bt="SquadCombat",Ft="TailedSquadCombat",_t="RectFlag",It="TriangleFlag",kt="CurveFlag",Dt=Object.freeze({TEXTAREA:st,ARC:"Arc",CURVE:at,GATHERING_PLACE:ht,POLYLINE:lt,FREEHANDLINE:ut,POINT:ct,PENNANT:pt,RECTANGLE:gt,CIRCLE:ft,ELLIPSE:dt,LUNE:vt,SECTOR:mt,CLOSED_CURVE:Pt,POLYGON:yt,FREE_POLYGON:wt,ATTACK_ARROW:Mt,DOUBLE_ARROW:Ct,STRAIGHT_ARROW:At,FINE_ARROW:xt,ASSAULT_DIRECTION:Et,TAILED_SQUAD_COMBAT:Ft,TAILED_ATTACK_ARROW:Tt,SQUAD_COMBAT:bt,RECTFLAG:_t,TRIANGLEFLAG:It,CURVEFLAG:kt}),St=function(o){function t(t,e,n){var i;return(i=o.call(this,[])||this).type=ct,i.options=n||{},i.set("params",i.options),i.fixPointCount=1,e&&0<e.length?i.setPoints(e):t&&0<t.length&&i.setCoordinates(t),i}h(t,o);var e=t.prototype;return e.getPlotType=function(){return this.type},e.generate=function(){var t=this.points[0];this.setCoordinates(t)},e.setMap=function(t){if(!(t&&t instanceof l.Map))throw new Error("传入的不是地图对象！");this.map=t},e.getMap=function(){return this.map},e.isPlot=function(){return!0},e.setPoints=function(t){this.points=t||[],1<=this.points.length&&this.generate()},e.getPoints=function(){return this.points.slice(0)},e.getPointCount=function(){return this.points.length},e.updatePoint=function(t,e){0<=e&&e<this.points.length&&(this.points[e]=t,this.generate())},e.updateLastPoint=function(t){this.updatePoint(t,this.points.length-1)},e.finishDrawing=function(){},t}(g.Point),Ht=function(o){function t(t,e,n){var i;return(i=o.call(this,[])||this).type=pt,i.options=n||{},i.set("params",i.options),e&&0<e.length?i.setPoints(e):t&&0<t.length&&i.setCoordinates(t),i}h(t,o);var e=t.prototype;return e.getPlotType=function(){return this.type},e.generate=function(){this.setCoordinates(this.points)},e.setMap=function(t){if(!(t&&t instanceof l.Map))throw new Error("传入的不是地图对象！");this.map=t},e.getMap=function(){return this.map},e.isPlot=function(){return!0},e.setPoints=function(t){this.points=t||[],1<=this.points.length&&this.generate()},e.getPoints=function(){return this.points.slice(0)},e.getPointCount=function(){return this.points.length},e.updatePoint=function(t,e){0<=e&&e<this.points.length&&(this.points[e]=t,this.generate())},e.updateLastPoint=function(t){this.updatePoint(t,this.points.length-1)},e.finishDrawing=function(){},t}(g.Point),Lt=function(o){function t(t,e,n){var i;return(i=o.call(this,[])||this).type=lt,i.freehand=!1,i.set("params",n),e&&0<e.length?i.setPoints(e):t&&0<t.length&&i.setCoordinates(t),i}h(t,o);var e=t.prototype;return e.getPlotType=function(){return this.type},e.generate=function(){this.setCoordinates(this.points)},e.setMap=function(t){if(!(t&&t instanceof l.Map))throw new Error("传入的不是地图对象！");this.map=t},e.getMap=function(){return this.map},e.isPlot=function(){return!0},e.setPoints=function(t){this.points=t||[],1<=this.points.length&&this.generate()},e.getPoints=function(){return this.points.slice(0)},e.getPointCount=function(){return this.points.length},e.updatePoint=function(t,e){0<=e&&e<this.points.length&&(this.points[e]=t,this.generate())},e.updateLastPoint=function(t){this.updatePoint(t,this.points.length-1)},e.finishDrawing=function(){},t}(g.LineString),Ot=function(o){function t(t,e,n){var i;return(i=o.call(this,[])||this).type="Arc",i.fixPointCount=3,i.set("params",n),e&&0<e.length?i.setPoints(e):t&&0<t.length&&i.setCoordinates(t),i}h(t,o);var e=t.prototype;return e.getPlotType=function(){return this.type},e.generate=function(){var t=this.getPointCount();if(!(t<2))if(2===t)this.setCoordinates(this.points);else{var e=[this.points[0],this.points[1],this.points[2],null,null],n=e[0],i=e[1],o=e[2],r=e[3],s=e[4],a=w(n,i,o),h=C(n,a),l=M(n,a),u=M(i,a);s=E(n,i,o)?(r=u,l):(r=l,u),this.setCoordinates(F(a,h,r,s))}},e.setMap=function(t){if(!(t&&t instanceof l.Map))throw new Error("传入的不是地图对象！");this.map=t},e.getMap=function(){return this.map},e.isPlot=function(){return!0},e.setPoints=function(t){this.points=t||[],1<=this.points.length&&this.generate()},e.getPoints=function(){return this.points.slice(0)},e.getPointCount=function(){return this.points.length},e.updatePoint=function(t,e){0<=e&&e<this.points.length&&(this.points[e]=t,this.generate())},e.updateLastPoint=function(t){this.updatePoint(t,this.points.length-1)},e.finishDrawing=function(){},t}(g.LineString),Nt=function(o){function t(t,e,n){var i;return(i=o.call(this,[])||this).type=ft,i.fixPointCount=2,i.set("params",n),e&&0<e.length?i.setPoints(e):t&&0<t.length&&i.setCoordinates(t),i}h(t,o);var e=t.prototype;return e.getPlotType=function(){return this.type},e.generate=function(){if(this.getPointCount()<2)return!1;var t=this.points[0],e=C(t,this.points[1]);this.setCoordinates([this.generatePoints(t,e)])},e.generatePoints=function(t,e){for(var n=null,i=null,o=null,r=[],s=0;s<=100;s++)o=2*Math.PI*s/100,n=t[0]+e*Math.cos(o),i=t[1]+e*Math.sin(o),r.push([n,i]);return r},e.setMap=function(t){if(!(t&&t instanceof l.Map))throw new Error("传入的不是地图对象！");this.map=t},e.getMap=function(){return this.map},e.isPlot=function(){return!0},e.setPoints=function(t){this.points=t||[],1<=this.points.length&&this.generate()},e.getPoints=function(){return this.points.slice(0)},e.getPointCount=function(){return this.points.length},e.updatePoint=function(t,e){0<=e&&e<this.points.length&&(this.points[e]=t,this.generate())},e.updateLastPoint=function(t){this.updatePoint(t,this.points.length-1)},e.finishDrawing=function(){},t}(g.Polygon),Rt=function(o){function t(t,e,n){var i;return(i=o.call(this,[])||this).type=at,i.t=.3,i.set("params",n),e&&0<e.length?i.setPoints(e):t&&0<t.length&&i.setCoordinates(t),i}h(t,o);var e=t.prototype;return e.getPlotType=function(){return this.type},e.generate=function(){var t=this.getPointCount();if(t<2)return!1;if(2===t)this.setCoordinates(this.points);else{var e=i(this.t,this.points);this.setCoordinates(e)}},e.setMap=function(t){if(!(t&&t instanceof l.Map))throw new Error("传入的不是地图对象！");this.map=t},e.getMap=function(){return this.map},e.isPlot=function(){return!0},e.setPoints=function(t){this.points=t||[],1<=this.points.length&&this.generate()},e.getPoints=function(){return this.points.slice(0)},e.getPointCount=function(){return this.points.length},e.updatePoint=function(t,e){0<=e&&e<this.points.length&&(this.points[e]=t,this.generate())},e.updateLastPoint=function(t){this.updatePoint(t,this.points.length-1)},e.finishDrawing=function(){},t}(g.LineString),Wt=function(o){function t(t,e,n){var i;return(i=o.call(this,[])||this).type=ut,i.freehand=!0,i.set("params",n),e&&0<e.length?i.setPoints(e):t&&0<t.length&&i.setCoordinates(t),i}h(t,o);var e=t.prototype;return e.getPlotType=function(){return this.type},e.generate=function(){this.setCoordinates(this.points)},e.setMap=function(t){if(!(t&&t instanceof l.Map))throw new Error("传入的不是地图对象！");this.map=t},e.getMap=function(){return this.map},e.isPlot=function(){return!0},e.setPoints=function(t){this.points=t||[],1<=this.points.length&&this.generate()},e.getPoints=function(){return this.points.slice(0)},e.getPointCount=function(){return this.points.length},e.updatePoint=function(t,e){0<=e&&e<this.points.length&&(this.points[e]=t,this.generate())},e.updateLastPoint=function(t){this.updatePoint(t,this.points.length-1)},e.finishDrawing=function(){},t}(g.LineString),zt=function(o){function t(t,e,n){var i;return(i=o.call(this,[])||this).type=gt,i.fixPointCount=2,i.set("params",n),i.isFill=!1!==n.isFill||n.isFill,e&&0<e.length?i.setPoints(e):t&&0<t.length&&i.setCoordinates(t),i}h(t,o);var e=t.prototype;return e.getPlotType=function(){return this.type},e.generate=function(){if(2===this.points.length){var t=[];if(this.isFill){var e=a.boundingExtent(this.points);t=r.fromExtent(e).getCoordinates()}else{var n=this.points[0],i=this.points[1];t=[n,[n[0],i[1]],i,[i[0],n[1]],n]}this.setCoordinates(t)}},e.setMap=function(t){if(!(t&&t instanceof l.Map))throw new Error("传入的不是地图对象！");this.map=t},e.getMap=function(){return this.map},e.isPlot=function(){return!0},e.setPoints=function(t){this.points=t||[],1<=this.points.length&&this.generate()},e.getPoints=function(){return this.points.slice(0)},e.getPointCount=function(){return this.points.length},e.updatePoint=function(t,e){0<=e&&e<this.points.length&&(this.points[e]=t,this.generate())},e.updateLastPoint=function(t){this.updatePoint(t,this.points.length-1)},e.finishDrawing=function(){},t}(g.Polygon),Bt=function(o){function t(t,e,n){var i;return(i=o.call(this,[])||this).type=dt,i.fixPointCount=2,i.set("params",n),e&&0<e.length?i.setPoints(e):t&&0<t.length&&i.setCoordinates(t),i}h(t,o);var e=t.prototype;return e.getPlotType=function(){return this.type},e.generate=function(){if(this.getPointCount()<2)return!1;var t=[this.points[0],this.points[1]],e=t[0],n=t[1],i=A(e,n),o=Math.abs((e[0]-n[0])/2),r=Math.abs((e[1]-n[1])/2),s=this.generatePoints(i,o,r);this.setCoordinates([s])},e.generatePoints=function(t,e,n){for(var i=null,o=null,r=null,s=[],a=0;a<=H;a++)r=2*Math.PI*a/H,i=t[0]+e*Math.cos(r),o=t[1]+n*Math.sin(r),s.push([i,o]);return s},e.setMap=function(t){if(!(t&&t instanceof l.Map))throw new Error("传入的不是地图对象！");this.map=t},e.getMap=function(){return this.map},e.isPlot=function(){return!0},e.setPoints=function(t){this.points=t||[],1<=this.points.length&&this.generate()},e.getPoints=function(){return this.points.slice(0)},e.getPointCount=function(){return this.points.length},e.updatePoint=function(t,e){0<=e&&e<this.points.length&&(this.points[e]=t,this.generate())},e.updateLastPoint=function(t){this.updatePoint(t,this.points.length-1)},e.finishDrawing=function(){},t}(g.Polygon),Vt=function(o){function t(t,e,n){var i;return(i=o.call(this,[])||this).type=vt,i.fixPointCount=3,i.set("params",n),e&&0<e.length?i.setPoints(e):t&&0<t.length&&i.setCoordinates(t),i}h(t,o);var e=t.prototype;return e.getPlotType=function(){return this.type},e.generate=function(){if(this.getPointCount()<2)return!1;var t=this.getPoints();if(2===this.getPointCount()){var e=A(t[0],t[1]),n=C(t[0],e),i=b(t[0],e,L,n);t.push(i)}var o=[t[0],t[1],t[2],void 0,void 0],r=o[0],s=o[1],a=o[2],h=o[3],l=o[4],u=w(r,s,a),c=C(r,u),p=M(r,u),g=M(s,u);l=E(r,s,a)?(h=g,p):(h=p,g),(t=F(u,c,h,l)).push(t[0]),this.setCoordinates([t])},e.setMap=function(t){if(!(t&&t instanceof l.Map))throw new Error("传入的不是地图对象！");this.map=t},e.getMap=function(){return this.map},e.isPlot=function(){return!0},e.setPoints=function(t){this.points=t||[],1<=this.points.length&&this.generate()},e.getPoints=function(){return this.points.slice(0)},e.getPointCount=function(){return this.points.length},e.updatePoint=function(t,e){0<=e&&e<this.points.length&&(this.points[e]=t,this.generate())},e.updateLastPoint=function(t){this.updatePoint(t,this.points.length-1)},e.finishDrawing=function(){},t}(g.Polygon),Gt=function(o){function t(t,e,n){var i;return(i=o.call(this,[])||this).type=mt,i.fixPointCount=3,i.set("params",n),e&&0<e.length?i.setPoints(e):t&&0<t.length&&i.setCoordinates(t),i}h(t,o);var e=t.prototype;return e.getPlotType=function(){return this.type},e.generate=function(){var t=this.getPointCount();if(t<2)return!1;if(2===t)this.setCoordinates([this.points]);else{var e=this.getPoints(),n=[e[0],e[1],e[2]],i=n[0],o=n[1],r=n[2],s=C(o,i),a=M(o,i),h=M(r,i),l=F(i,s,a,h);l.push(i,l[0]),this.setCoordinates([l])}},e.setMap=function(t){if(!(t&&t instanceof l.Map))throw new Error("传入的不是地图对象！");this.map=t},e.getMap=function(){return this.map},e.isPlot=function(){return!0},e.setPoints=function(t){this.points=t||[],1<=this.points.length&&this.generate()},e.getPoints=function(){return this.points.slice(0)},e.getPointCount=function(){return this.points.length},e.updatePoint=function(t,e){0<=e&&e<this.points.length&&(this.points[e]=t,this.generate())},e.updateLastPoint=function(t){this.updatePoint(t,this.points.length-1)},e.finishDrawing=function(){},t}(g.Polygon),Yt=function(o){function t(t,e,n){var i;return(i=o.call(this,[])||this).type=Pt,i.t=.3,i.set("params",n),e&&0<e.length?i.setPoints(e):t&&0<t.length&&i.setCoordinates(t),i}h(t,o);var e=t.prototype;return e.getPlotType=function(){return this.type},e.generate=function(){var t=this.getPointCount();if(t<2)return!1;if(2===t)this.setCoordinates([this.points]);else{var e=this.getPoints();e.push(e[0],e[1]);for(var n=[],i=[],o=0;o<e.length-2;o++){var r=_(this.t,e[o],e[o+1],e[o+2]);n=n.concat(r)}var s=n.length;n=[n[s-1]].concat(n.slice(0,s-1));for(var a=0;a<e.length-2;a++){var h=e[a],l=e[a+1];i.push(h);for(var u=0;u<=H;u++){var c=T(u/H,h,n[2*a],n[2*a+1],l);i.push(c)}i.push(l)}this.setCoordinates([i])}},e.setMap=function(t){if(!(t&&t instanceof l.Map))throw new Error("传入的不是地图对象！");this.map=t},e.getMap=function(){return this.map},e.isPlot=function(){return!0},e.setPoints=function(t){this.points=t||[],1<=this.points.length&&this.generate()},e.getPoints=function(){return this.points.slice(0)},e.getPointCount=function(){return this.points.length},e.updatePoint=function(t,e){0<=e&&e<this.points.length&&(this.points[e]=t,this.generate())},e.updateLastPoint=function(t){this.updatePoint(t,this.points.length-1)},e.finishDrawing=function(){},t}(g.Polygon),Ut=function(o){function t(t,e,n){var i;return(i=o.call(this,[])||this).type=yt,i.set("params",n),e&&0<e.length?i.setPoints(e):t&&0<t.length&&i.setCoordinates(t),i}h(t,o);var e=t.prototype;return e.getPlotType=function(){return this.type},e.generate=function(){if(this.getPointCount()<2)return!1;this.setCoordinates([this.points])},e.setMap=function(t){if(!(t&&t instanceof l.Map))throw new Error("传入的不是地图对象！");this.map=t},e.getMap=function(){return this.map},e.isPlot=function(){return!0},e.setPoints=function(t){this.points=t||[],1<=this.points.length&&this.generate()},e.getPoints=function(){return this.points.slice(0)},e.getPointCount=function(){return this.points.length},e.updatePoint=function(t,e){0<=e&&e<this.points.length&&(this.points[e]=t,this.generate())},e.updateLastPoint=function(t){this.updatePoint(t,this.points.length-1)},e.finishDrawing=function(){},t}(g.Polygon),jt=function(o){function t(t,e,n){var i;return(i=o.call(this,[])||this).type=wt,i.freehand=!0,i.set("params",n),e&&0<e.length?i.setPoints(e):t&&0<t.length&&i.setCoordinates(t),i}h(t,o);var e=t.prototype;return e.getPlotType=function(){return this.type},e.generate=function(){this.setCoordinates([this.points])},e.setMap=function(t){if(!(t&&t instanceof l.Map))throw new Error("传入的不是地图对象！");this.map=t},e.getMap=function(){return this.map},e.isPlot=function(){return!0},e.setPoints=function(t){this.points=t||[],1<=this.points.length&&this.generate()},e.getPoints=function(){return this.points.slice(0)},e.getPointCount=function(){return this.points.length},e.updatePoint=function(t,e){0<=e&&e<this.points.length&&(this.points[e]=t,this.generate())},e.updateLastPoint=function(t){this.updatePoint(t,this.points.length-1)},e.finishDrawing=function(){},t}(g.Polygon),qt=function(o){function t(t,e,n){var i;return(i=o.call(this,[])||this).type=Mt,i.headHeightFactor=.18,i.headWidthFactor=.3,i.neckHeightFactor=.85,i.neckWidthFactor=.15,i.headTailFactor=.8,i.set("params",n),e&&0<e.length?i.setPoints(e):t&&0<t.length&&i.setCoordinates(t),i}h(t,o);var e=t.prototype;return e.getPlotType=function(){return this.type},e.generate=function(){try{var t=this.getPointCount();if(t<2)return!1;if(2===t)this.setCoordinates([this.points]);else{var e=this.getPoints(),n=[e[0],e[1]],i=n[0],o=n[1];E(e[0],e[1],e[2])&&(i=e[1],o=e[0]);var r=[A(i,o)].concat(e.slice(2)),s=this.getArrowHeadPoints(r,i,o),a=[s[0],s[4]],h=a[0],l=a[1],u=C(i,o)/y(r),c=this.getArrowBodyPoints(r,h,l,u),p=c.length,g=[i].concat(c.slice(0,p/2));g.push(h);var f=[o].concat(c.slice(p/2,p));f.push(l),g=D(g),f=D(f),this.setCoordinates([g.concat(s,f.reverse())])}}catch(t){console.log(t)}},e.getArrowPoints=function(t,e,n,i){var o=A(t,e),r=C(o,n),s=b(n,o,0,.3*r,!0),a=b(n,o,0,.5*r,!0),h=[o,s=b(o,s,L,r/5,i),a=b(o,a,L,r/4,i),n],l=this.getArrowHeadPoints(h);if(!(l&&Array.isArray(l)&&0<l.length))throw new Error("插值出错");var u=[l[0],l[4]],c=u[0],p=u[1],g=C(t,e)/y(h)/2,f=this.getArrowBodyPoints(h,c,p,g);if(f){var d=f.length,v=f.slice(0,d/2),m=f.slice(d/2,d);return v.push(c),m.push(p),(v=v.reverse()).push(e),(m=m.reverse()).push(t),v.reverse().concat(l,m)}},e.getArrowHeadPoints=function(t,e,n){try{var i=y(t),o=i*this.headHeightFactor,r=t[t.length-1];i=C(r,t[t.length-2]);var s=C(e,n);o>s*this.headTailFactor&&(o=s*this.headTailFactor);var a=o*this.headWidthFactor,h=o*this.neckWidthFactor,l=(o=i<o?i:o)*this.neckHeightFactor,u=b(t[t.length-2],r,0,o,!0),c=b(t[t.length-2],r,0,l,!0),p=b(r,u,L,a,!1),g=b(r,u,L,a,!0);return[b(r,c,L,h,!1),p,r,g,b(r,c,L,h,!0)]}catch(t){console.log(t)}},e.getArrowBodyPoints=function(t,e,n,i){for(var o=P(t),r=y(t)*i,s=(r-C(e,n))/2,a=0,h=[],l=[],u=1;u<t.length-1;u++){var c=x(t[u-1],t[u],t[u+1])/2,p=(r/2-(a+=C(t[u-1],t[u]))/o*s)/Math.sin(c),g=b(t[u-1],t[u],Math.PI-c,p,!0),f=b(t[u-1],t[u],c,p,!1);h.push(g),l.push(f)}return h.concat(l)},e.getTempPoint4=function(t,e,n){try{var i=A(t,e),o=C(i,n),r=x(t,i,n),s=void 0,a=void 0,h=void 0;return r<L?(s=o*Math.sin(r),a=o*Math.cos(r),h=b(t,i,L,s,!1),b(i,h,L,a,!0)):L<=r&&r<Math.PI?(s=o*Math.sin(Math.PI-r),a=o*Math.cos(Math.PI-r),h=b(t,i,L,s,!1),b(i,h,L,a,!1)):r>=Math.PI&&r<1.5*Math.PI?(s=o*Math.sin(r-Math.PI),a=o*Math.cos(r-Math.PI),h=b(t,i,L,s,!0),b(i,h,L,a,!0)):(s=o*Math.sin(2*Math.PI-r),a=o*Math.cos(2*Math.PI-r),h=b(t,i,L,s,!0),b(i,h,L,a,!1))}catch(t){console.log(t)}},e.setMap=function(t){if(!(t&&t instanceof l.Map))throw new Error("传入的不是地图对象！");this.map=t},e.getMap=function(){return this.map},e.isPlot=function(){return!0},e.setPoints=function(t){this.points=t||[],1<=this.points.length&&this.generate()},e.getPoints=function(){return this.points.slice(0)},e.getPointCount=function(){return this.points.length},e.updatePoint=function(t,e){0<=e&&e<this.points.length&&(this.points[e]=t,this.generate())},e.updateLastPoint=function(t){this.updatePoint(t,this.points.length-1)},e.finishDrawing=function(){},t}(g.Polygon),Xt=function(o){function t(t,e,n){var i;return(i=o.call(this,[])||this).type=Ct,i.headHeightFactor=.25,i.headWidthFactor=.3,i.neckHeightFactor=.85,i.neckWidthFactor=.15,i.connPoint=null,i.tempPoint4=null,i.fixPointCount=4,i.set("params",n),e&&0<e.length?i.setPoints(e):t&&0<t.length&&i.setCoordinates(t),i}h(t,o);var e=t.prototype;return e.getPlotType=function(){return this.type},e.generate=function(){try{var t=this.getPointCount();if(t<2)return!1;if(2===t)return this.setCoordinates([this.points]),!1;if(2<t){var e=[this.points[0],this.points[1],this.points[2]],n=e[0],i=e[1],o=e[2];3===t?(this.tempPoint4=this.getTempPoint4(n,i,o),this.connPoint=A(n,i)):4===t?(this.tempPoint4=this.points[3],this.connPoint=A(n,i)):(this.tempPoint4=this.points[3],this.connPoint=this.points[4]);var r=void 0,s=void 0;s=E(n,i,o)?(r=this.getArrowPoints(n,this.connPoint,this.tempPoint4,!1),this.getArrowPoints(this.connPoint,i,o,!0)):(r=this.getArrowPoints(i,this.connPoint,o,!1),this.getArrowPoints(this.connPoint,n,this.tempPoint4,!0));var a=r.length,h=(a-5)/2,l=r.slice(0,h),u=r.slice(h,5+h),c=r.slice(5+h,a),p=s.slice(0,h),g=s.slice(h,5+h),f=s.slice(5+h,a);p=I(p);var d=I(f.concat(l.slice(1)));c=I(c);var v=p.concat(g,d,u,c);this.setCoordinates([v])}}catch(t){console.log(t)}},e.getArrowPoints=function(t,e,n,i){var o=A(t,e),r=C(o,n),s=b(n,o,0,.3*r,!0),a=b(n,o,0,.5*r,!0),h=[o,s=b(o,s,L,r/5,i),a=b(o,a,L,r/4,i),n],l=this.getArrowHeadPoints(h);if(!(l&&Array.isArray(l)&&0<l.length))throw new Error("插值出错");var u=[l[0],l[4]],c=u[0],p=u[1],g=C(t,e)/y(h)/2,f=this.getArrowBodyPoints(h,c,p,g);if(f){var d=f.length,v=f.slice(0,d/2),m=f.slice(d/2,d);return v.push(c),m.push(p),(v=v.reverse()).push(e),(m=m.reverse()).push(t),v.reverse().concat(l,m)}},e.getArrowHeadPoints=function(t){try{var e=y(t)*this.headHeightFactor,n=t[t.length-1],i=e*this.headWidthFactor,o=e*this.neckWidthFactor,r=e*this.neckHeightFactor,s=b(t[t.length-2],n,0,e,!0),a=b(t[t.length-2],n,0,r,!0),h=b(n,s,L,i,!1),l=b(n,s,L,i,!0);return[b(n,a,L,o,!1),h,n,l,b(n,a,L,o,!0)]}catch(t){console.log(t)}},e.getArrowBodyPoints=function(t,e,n,i){for(var o=P(t),r=y(t)*i,s=(r-C(e,n))/2,a=0,h=[],l=[],u=1;u<t.length-1;u++){var c=x(t[u-1],t[u],t[u+1])/2,p=(r/2-(a+=C(t[u-1],t[u]))/o*s)/Math.sin(c),g=b(t[u-1],t[u],Math.PI-c,p,!0),f=b(t[u-1],t[u],c,p,!1);h.push(g),l.push(f)}return h.concat(l)},e.getTempPoint4=function(t,e,n){try{var i=A(t,e),o=C(i,n),r=x(t,i,n),s=void 0,a=void 0,h=void 0;return r<L?(s=o*Math.sin(r),a=o*Math.cos(r),h=b(t,i,L,s,!1),b(i,h,L,a,!0)):L<=r&&r<Math.PI?(s=o*Math.sin(Math.PI-r),a=o*Math.cos(Math.PI-r),h=b(t,i,L,s,!1),b(i,h,L,a,!1)):r>=Math.PI&&r<1.5*Math.PI?(s=o*Math.sin(r-Math.PI),a=o*Math.cos(r-Math.PI),h=b(t,i,L,s,!0),b(i,h,L,a,!0)):(s=o*Math.sin(2*Math.PI-r),a=o*Math.cos(2*Math.PI-r),h=b(t,i,L,s,!0),b(i,h,L,a,!1))}catch(t){console.log(t)}},e.setMap=function(t){if(!(t&&t instanceof l.Map))throw new Error("传入的不是地图对象！");this.map=t},e.getMap=function(){return this.map},e.isPlot=function(){return!0},e.setPoints=function(t){this.points=t||[],1<=this.points.length&&this.generate()},e.getPoints=function(){return this.points.slice(0)},e.getPointCount=function(){return this.points.length},e.updatePoint=function(t,e){0<=e&&e<this.points.length&&(this.points[e]=t,this.generate())},e.updateLastPoint=function(t){this.updatePoint(t,this.points.length-1)},e.finishDrawing=function(){3===this.getPointCount()&&null!==this.tempPoint4&&this.points.push(this.tempPoint4),null!==this.connPoint&&this.points.push(this.connPoint)},t}(g.Polygon),Zt=function(o){function t(t,e,n){var i;return(i=o.call(this,[])||this).type=At,i.fixPointCount=2,i.maxArrowLength=3e6,i.arrowLengthScale=5,i.set("params",n),e&&0<e.length?i.setPoints(e):t&&0<t.length&&i.setCoordinates(t),i}h(t,o);var e=t.prototype;return e.getPlotType=function(){return this.type},e.generate=function(){try{if(this.getPointCount()<2)return!1;var t=this.getPoints(),e=[t[0],t[1]],n=e[0],i=e[1],o=C(n,i)/this.arrowLengthScale;o=o>this.maxArrowLength?this.maxArrowLength:o;var r=b(n,i,Math.PI/6,o,!1),s=b(n,i,Math.PI/6,o,!0);this.setCoordinates([n,i,r,i,s])}catch(t){console.log(t)}},e.setMap=function(t){if(!(t&&t instanceof l.Map))throw new Error("传入的不是地图对象！");this.map=t},e.getMap=function(){return this.map},e.isPlot=function(){return!0},e.setPoints=function(t){this.points=t||[],1<=this.points.length&&this.generate()},e.getPoints=function(){return this.points.slice(0)},e.getPointCount=function(){return this.points.length},e.updatePoint=function(t,e){0<=e&&e<this.points.length&&(this.points[e]=t,this.generate())},e.updateLastPoint=function(t){this.updatePoint(t,this.points.length-1)},e.finishDrawing=function(){},t}(g.LineString),Kt=function(o){function t(t,e,n){var i;return(i=o.call(this,[])||this).type=xt,i.tailWidthFactor=.1,i.neckWidthFactor=.2,i.headWidthFactor=.25,i.headAngle=Math.PI/8.5,i.neckAngle=Math.PI/13,i.fixPointCount=2,i.set("params",n),e&&0<e.length?i.setPoints(e):t&&0<t.length&&i.setCoordinates(t),i}h(t,o);var e=t.prototype;return e.getPlotType=function(){return this.type},e.generate=function(){try{if(this.getPointCount()<2)return!1;var t=this.getPoints(),e=[t[0],t[1]],n=e[0],i=e[1],o=y(t),r=o*this.tailWidthFactor,s=o*this.neckWidthFactor,a=o*this.headWidthFactor,h=b(i,n,L,r,!0),l=b(i,n,L,r,!1),u=b(n,i,this.headAngle,a,!1),c=b(n,i,this.headAngle,a,!0),p=[h,b(n,i,this.neckAngle,s,!1),u,i,c,b(n,i,this.neckAngle,s,!0),l];this.setCoordinates([p])}catch(t){console.log(t)}},e.setMap=function(t){if(!(t&&t instanceof l.Map))throw new Error("传入的不是地图对象！");this.map=t},e.getMap=function(){return this.map},e.isPlot=function(){return!0},e.setPoints=function(t){this.points=t||[],1<=this.points.length&&this.generate()},e.getPoints=function(){return this.points.slice(0)},e.getPointCount=function(){return this.points.length},e.updatePoint=function(t,e){0<=e&&e<this.points.length&&(this.points[e]=t,this.generate())},e.updateLastPoint=function(t){this.updatePoint(t,this.points.length-1)},e.finishDrawing=function(){},t}(g.Polygon),Qt=(h(Jt,ot=Kt),Jt);function Jt(t,e,n){var i;return(i=ot.call(this,t,e,n)||this).tailWidthFactor=.05,i.neckWidthFactor=.1,i.headWidthFactor=.15,i.type=Et,i.headAngle=Math.PI/4,i.neckAngle=.17741*Math.PI,e&&0<e.length?i.setPoints(e):t&&0<t.length&&i.setCoordinates(t),i.set("params",n),i}var $t,te=(h(ee,$t=qt),ee.prototype.generate=function(){try{var t=this.getPointCount();if(t<2)return!1;if(2===t)return this.setCoordinates([this.points]),!1;var e=this.getPoints(),n=[e[0],e[1]],i=n[0],o=n[1];E(e[0],e[1],e[2])&&(i=e[1],o=e[0]);var r=[A(i,o)].concat(e.slice(2)),s=this.getArrowHeadPoints(r,i,o),a=[s[0],s[4]],h=a[0],l=a[1],u=C(i,o),c=y(r),p=c*this.tailWidthFactor*this.swallowTailFactor;this.swallowTailPnt=b(r[1],r[0],0,p,!0);var g=u/c,f=this.getArrowBodyPoints(r,h,l,g),d=f.length,v=[i].concat(f.slice(0,d/2));v.push(h);var m=[o].concat(f.slice(d/2,d));m.push(l),v=D(v),m=D(m),this.setCoordinates([v.concat(s,m.reverse(),[this.swallowTailPnt,v[0]])])}catch(t){console.log(t)}},ee);function ee(t,e,n){var i;return(i=$t.call(this,t,e,n)||this).type=Tt,i.headHeightFactor=.18,i.headWidthFactor=.3,i.neckHeightFactor=.85,i.neckWidthFactor=.15,i.tailWidthFactor=.1,i.headTailFactor=.8,i.swallowTailFactor=1,i.swallowTailPnt=null,i.set("params",n),e&&0<e.length?i.setPoints(e):t&&0<t.length&&i.setCoordinates(t),i}function ne(t){var e=t&&"object"==typeof t?t:{},n=new u.Style({});return e.geometry&&e.geometry instanceof g.Geometry&&n.setGeometry(e.geometry),e.zIndex&&"number"==typeof e.zIndex&&n.setZIndex(e.zIndex),e.fill&&"object"==typeof e.fill&&n.setFill(this._getFill(e.fill)),e.image&&"object"==typeof e.image&&n.setImage(this._getImage(e.image)),e.stroke&&"object"==typeof e.stroke&&n.setStroke(this._getStroke(e.stroke)),e.text&&"object"==typeof e.text&&n.setText(this._getText(e.text)),n}var ie=function(o){function t(t,e,n){var i;return(i=o.call(this,t,e,n)||this).type=bt,i.headHeightFactor=.18,i.headWidthFactor=.3,i.neckHeightFactor=.85,i.neckWidthFactor=.15,i.tailWidthFactor=.1,i.set("params",n),e&&0<e.length?i.setPoints(e):t&&0<t.length&&i.setCoordinates(t),i}h(t,o);var e=t.prototype;return e.generate=function(){try{if(this.getPointCount()<2)return!1;var t=this.getPoints(),e=this.getTailPoints(t),n=this.getArrowHeadPoints(t,e[0],e[1]),i=n[0],o=n[4],r=this.getArrowBodyPoints(t,i,o,this.tailWidthFactor),s=r.length,a=[e[0]].concat(r.slice(0,s/2));a.push(i);var h=[e[1]].concat(r.slice(s/2,s));h.push(o),a=D(a),h=D(h),this.setCoordinates([a.concat(n,h.reverse())])}catch(t){console.log(t)}},e.getTailPoints=function(t){var e=y(t)*this.tailWidthFactor;return[b(t[1],t[0],L,e,!1),b(t[1],t[0],L,e,!0)]},t}(qt),oe=function(o){function t(t,e,n){var i;return(i=o.call(this,t,e,n)||this).type=Ft,i.headHeightFactor=.18,i.headWidthFactor=.3,i.neckHeightFactor=.85,i.neckWidthFactor=.15,i.tailWidthFactor=.1,i.swallowTailFactor=1,i.swallowTailPnt=null,i.fixPointCount=2,i.set("params",n),e&&0<e.length?i.setPoints(e):t&&0<t.length&&i.setCoordinates(t),i}h(t,o);var e=t.prototype;return e.generate=function(){try{if(this.getPointCount()<2)return!1;var t=this.getPoints(),e=this.getTailPoints(t),n=this.getArrowHeadPoints(t,e[0],e[2]),i=n[0],o=n[4],r=this.getArrowBodyPoints(t,i,o,this.tailWidthFactor),s=r.length,a=[e[0]].concat(r.slice(0,s/2));a.push(i);var h=[e[2]].concat(r.slice(s/2,s));h.push(o),a=D(a),h=D(h),this.setCoordinates([a.concat(n,h.reverse(),[e[1],a[0]])])}catch(t){console.log(t)}},e.getTailPoints=function(t){var e=y(t)*this.tailWidthFactor,n=b(t[1],t[0],L,e,!1),i=b(t[1],t[0],L,e,!0),o=e*this.swallowTailFactor;return[n,b(t[1],t[0],0,o,!0),i]},t}(qt),re=function(o){function t(t,e,n){var i;return(i=o.call(this,[])||this).type=ht,i.t=.4,i.fixPointCount=3,i.set("params",n),e&&0<e.length?i.setPoints(e):t&&0<t.length&&i.setCoordinates(t),i}h(t,o);var e=t.prototype;return e.getPlotType=function(){return this.type},e.generate=function(){var t=this.getPoints(),e=this.getPointCount();if(t.length<2)return!1;if(2===e){var n=A(t[0],t[1]),i=C(t[0],n)/.9,o=b(t[0],n,L,i,!0);t=[t[0],o,t[1]]}var r=A(t[0],t[2]);t.push(r,t[0],t[1]);for(var s=[],a=void 0,h=void 0,l=void 0,u=[],c=0;c<t.length-2;c++){a=t[c],h=t[c+1],l=t[c+2];var p=_(this.t,a,h,l);s=s.concat(p)}var g=s.length;s=[s[g-1]].concat(s.slice(0,g-1));for(var f=0;f<t.length-2;f++){a=t[f],h=t[f+1],u.push(a);for(var d=0;d<=H;d++){var v=T(d/H,a,s[2*f],s[2*f+1],h);u.push(v)}u.push(h)}this.setCoordinates([u])},e.setMap=function(t){if(!(t&&t instanceof l.Map))throw new Error("传入的不是地图对象！");this.map=t},e.getMap=function(){return this.map},e.isPlot=function(){return!0},e.setPoints=function(t){this.points=t||[],1<=this.points.length&&this.generate()},e.getPoints=function(){return this.points.slice(0)},e.getPointCount=function(){return this.points.length},e.updatePoint=function(t,e){0<=e&&e<this.points.length&&(this.points[e]=t,this.generate())},e.updateLastPoint=function(t){this.updatePoint(t,this.points.length-1)},e.finishDrawing=function(){},t}(g.Polygon),se=function(o){function t(t,e,n){var i;return(i=o.call(this,[])||this).type=_t,i.fixPointCount=2,i.set("params",n),e&&0<e.length?i.setPoints(e):t&&0<t.length&&i.setCoordinates(t),i}h(t,o);var e=t.prototype;return e.getPlotType=function(){return this.type},e.generate=function(){if(this.getPointCount()<2)return!1;this.setCoordinates([this.calculatePonits(this.points)])},e.calculatePonits=function(t){var e=[];if(1<t.length){var n=t[0],i=t[t.length-1];e=[n,[i[0],n[1]],[i[0],(n[1]+i[1])/2],[n[0],(n[1]+i[1])/2],[n[0],i[1]]]}return e},e.setMap=function(t){if(!(t&&t instanceof l.Map))throw new Error("传入的不是地图对象！");this.map=t},e.getMap=function(){return this.map},e.isPlot=function(){return!0},e.setPoints=function(t){this.points=t||[],1<=this.points.length&&this.generate()},e.getPoints=function(){return this.points.slice(0)},e.getPointCount=function(){return this.points.length},e.updatePoint=function(t,e){0<=e&&e<this.points.length&&(this.points[e]=t,this.generate())},e.updateLastPoint=function(t){this.updatePoint(t,this.points.length-1)},e.finishDrawing=function(){},t}(g.Polygon),ae=function(o){function t(t,e,n){var i;return(i=o.call(this,[])||this).type=It,i.fixPointCount=2,i.set("params",n),e&&0<e.length?i.setPoints(e):t&&0<t.length&&i.setCoordinates(t),i}h(t,o);var e=t.prototype;return e.getPlotType=function(){return this.type},e.generate=function(){if(this.getPointCount()<2)return!1;this.setCoordinates([this.calculatePonits(this.points)])},e.calculatePonits=function(t){var e=[];if(1<t.length){var n=t[0],i=t[t.length-1];e=[n,[i[0],(n[1]+i[1])/2],[n[0],(n[1]+i[1])/2],[n[0],i[1]]]}return e},e.setMap=function(t){if(!(t&&t instanceof l.Map))throw new Error("传入的不是地图对象！");this.map=t},e.getMap=function(){return this.map},e.isPlot=function(){return!0},e.setPoints=function(t){this.points=t||[],1<=this.points.length&&this.generate()},e.getPoints=function(){return this.points.slice(0)},e.getPointCount=function(){return this.points.length},e.updatePoint=function(t,e){0<=e&&e<this.points.length&&(this.points[e]=t,this.generate())},e.updateLastPoint=function(t){this.updatePoint(t,this.points.length-1)},e.finishDrawing=function(){},t}(g.Polygon),he=function(o){function t(t,e,n){var i;return(i=o.call(this,[])||this).type=kt,i.fixPointCount=2,i.set("params",n),e&&0<e.length?i.setPoints(e):t&&0<t.length&&i.setCoordinates(t),i}h(t,o);var e=t.prototype;return e.getPlotType=function(){return this.type},e.generate=function(){if(this.getPointCount()<2)return!1;this.setCoordinates([this.calculatePonits(this.points)])},e.calculatePonits=function(t){var e=[];if(1<t.length){var n=t[0],i=t[t.length-1],o=n,r=[(i[0]-n[0])/4+n[0],(i[1]-n[1])/8+n[1]],s=[(n[0]+i[0])/2,n[1]],a=[3*(i[0]-n[0])/4+n[0],-(i[1]-n[1])/8+n[1]],h=[i[0],n[1]],l=[i[0],(n[1]+i[1])/2],u=[3*(i[0]-n[0])/4+n[0],3*(i[1]-n[1])/8+n[1]],c=[(n[0]+i[0])/2,(n[1]+i[1])/2],p=[(i[0]-n[0])/4+n[0],5*(i[1]-n[1])/8+n[1]],g=[n[0],(n[1]+i[1])/2],f=[n[0],i[1]],d=I([o,r,s,a,h]),v=I([l,u,c,p,g]);(e=d.concat(v)).push(f)}return e},e.setMap=function(t){if(!(t&&t instanceof l.Map))throw new Error("传入的不是地图对象！");this.map=t},e.getMap=function(){return this.map},e.isPlot=function(){return!0},e.setPoints=function(t){this.points=t||[],1<=this.points.length&&this.generate()},e.getPoints=function(){return this.points.slice(0)},e.getPointCount=function(){return this.points.length},e.updatePoint=function(t,e){0<=e&&e<this.points.length&&(this.points[e]=t,this.generate())},e.updateLastPoint=function(t){this.updatePoint(t,this.points.length-1)},e.finishDrawing=function(){},t}(g.Polygon),le=Object.freeze({Point:St,Pennant:Ht,Polyline:Lt,Arc:Ot,Circle:Nt,Curve:Rt,FreeHandLine:Wt,RectAngle:zt,Ellipse:Bt,Lune:Vt,Sector:Gt,ClosedCurve:Yt,Polygon:Ut,FreePolygon:jt,AttackArrow:qt,DoubleArrow:Xt,StraightArrow:Zt,FineArrow:Kt,AssaultDirection:Qt,TailedAttackArrow:te,SquadCombat:ie,TailedSquadCombat:oe,GatheringPlace:re,RectFlag:se,TriangleFlag:ae,CurveFlag:he,PlotTextBox:rt}),ue=function(i){function t(t,e){var n;if(n=i.call(this)||this,!(t&&t instanceof l.Map))throw new Error("传入的不是地图对象！");return n.map=t,n.options=e||{},n.points=null,n.plot=null,n.feature=null,n.plotType=null,n.plotParams=null,n.mapViewport=n.map.getViewport(),n.dblClickZoomInteraction=null,n.drawInteraction_=null,n.layerName=n.options&&n.options.layerName?n.options.layerName:N,U(["textAreaDrawEnd","mapFirstClickHandler","mapNextClickHandler","mapDoubleClickHandler","mapMouseMoveHandler"],v(n)),n.drawLayer=q(n.map,n.layerName,{create:!0}),n.drawLayer.setZIndex(n.options.zIndex||99),n}h(t,i);var e=t.prototype;return e.createPlot=function(t,e,n){var i=n||{};switch(t){case st:return"TextArea";case ct:return new St([],e,i);case pt:return new Ht([],e,i);case lt:return new Lt([],e,i);case"Arc":return new Ot([],e,i);case ft:return new Nt([],e,i);case at:return new Rt([],e,i);case ut:return new Wt([],e,i);case gt:return new zt([],e,i);case dt:return new Bt([],e,i);case vt:return new Vt([],e,i);case mt:return new Gt([],e,i);case Pt:return new Yt([],e,i);case yt:return new Ut([],e,i);case Mt:return new qt([],e,i);case wt:return new jt([],e,i);case Ct:return new Xt([],e,i);case At:return new Zt([],e,i);case xt:return new Kt([],e,i);case Et:return new Qt([],e,i);case Tt:return new te([],e,i);case bt:return new ie([],e,i);case Ft:return new oe([],e,i);case ht:return new re([],e,i);case _t:return new se([],e,i);case It:return new ae([],e,i);case kt:return new he([],e,i)}return null},e.active=function(e,t){void 0===t&&(t={}),this.disActive(),this.deactiveMapTools(),this.plotType=e,this.plotParams=t,e===st?this.activeInteraction():Object.keys(Dt).some(function(t){return Dt[t]===e})?this.map.on("click",this.mapFirstClickHandler):console.warn("不存在的标绘类型！")},e.activeInteraction=function(){this.drawInteraction_=new o.Draw({style:new u.Style({fill:new u.Fill({color:"rgba(255, 255, 255, 0.7)"}),stroke:new u.Stroke({color:"rgba(0, 0, 0, 0.15)",width:2}),image:new u.Icon({anchor:[1,1],anchorXUnits:"fraction",anchorYUnits:"fraction",opacity:.75,src:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAABgklEQVQ4T41T0W3CQAy1lfwRqR0h/CE5UhkBJmiZADpB0wlKJwA2aDegE5QR+Igl/noj9OPuLydXPuXQEYUKS5FyPvvd87ONRDRFxEdr7c4Y8ws3WFmW90VRvIjIF1ZVtQaANxH59N6v8zwvRaQEgCMATDu88I+Ipm1bk2XZHhEfAOAdFW00Gh2YOQafOeidHoaYEdGHc65GDZhMJuXpdDJ99hqkPmZe9e9iTgCoqmrWNM0hDerq/FGftXbcZxFzAgARrZg5vBaNiGpE3OhZRF6Zedu7DzkRYMrMKlQKYBBRQVVgw8zj3n3IGWSg9ESkds6tiqJQbe4AYJ6WGVkPAqh4+romdP9LbXMqZh/gXIKqm+d5EK9vbduOY7d0AAdL6AYLmqbRAQtGRMc4ONF/wSC2RF/PsuwbABapqLEjKqb3fq4sLtoYh6Lbiydr7TbtuwYDgH5qB9XmPEjdKG+Y+Xmo7ms+Lcs5N0uX6ei9X9y4TGtEXIZlukb7PzbdmNcisv8DtQILak2vZsYAAAAASUVORK5CYII="})}),type:"Circle",geometryFunction:n.createBox()}),this.map.addInteraction(this.drawInteraction_),this.drawInteraction_.on("drawend",this.textAreaDrawEnd)},e.textAreaDrawEnd=function(t){if(t&&t.feature){this.map.removeInteraction(this.drawInteraction_);var e=t.feature.getGeometry().getExtent(),n=[(e[0]+e[2])/2,(e[1]+e[3])/2],i=this.map.getPixelFromCoordinate([e[0],e[1]]),o=this.map.getPixelFromCoordinate([e[2],e[3]]),r=[Math.abs(i[0]-o[0]),Math.abs(i[1]-o[1])],s=r[0],a=r[1],h=new rt({id:function(){for(var t=[],e="0123456789abcdef",n=0;n<36;n++)t[n]=e.substr(Math.floor(16*Math.random()),1);return t[14]="4",t[19]=e.substr(3&t[19]|8,1),t[8]=t[13]=t[18]=t[23]="-",t.join("")}(),position:n,value:"",width:s,height:a,style:{width:s+"px",height:a+"px"}});this.map&&this.map instanceof l.Map&&h?this.map.addOverlay(h):console.warn("未传入地图对象或者plotText创建失败！")}else console.info("未获取到要素！")},e.disActive=function(){this.removeEventHandlers(),this.drawInteraction_&&(this.map.removeInteraction(this.drawInteraction_),this.drawInteraction_=null),this.points=[],this.plot=null,this.feature=null,this.plotType=null,this.plotParams=null,this.activateMapTools()},e.isDrawing=function(){return!!this.plotType},e.mapFirstClickHandler=function(t){this.map.un("click",this.mapFirstClickHandler),this.points.push(t.coordinate),this.plot=this.createPlot(this.plotType,this.points,this.plotParams),this.feature=new c(this.plot),this.feature.set("isPlot",!0),this.drawLayer.getSource().addFeature(this.feature),this.plotType===ct||this.plotType===pt?(this.plot.finishDrawing(),this.drawEnd(t)):(this.map.on("click",this.mapNextClickHandler),this.plot.freehand||this.map.on("dblclick",this.mapDoubleClickHandler),this.map.un("pointermove",this.mapMouseMoveHandler),this.map.on("pointermove",this.mapMouseMoveHandler)),this.plotType&&this.feature&&(this.plotParams.plotType=this.plotType,this.feature.setProperties(this.plotParams))},e.mapNextClickHandler=function(t){if(!this.plot.freehand&&C(t.coordinate,this.points[this.points.length-1])<1e-4)return!1;this.points.push(t.coordinate),this.plot.setPoints(this.points),this.plot.fixPointCount===this.plot.getPointCount()&&this.mapDoubleClickHandler(t),this.plot&&this.plot.freehand&&this.mapDoubleClickHandler(t)},e.mapDoubleClickHandler=function(t){t.preventDefault(),this.plot.finishDrawing(),this.drawEnd(t)},e.mapMouseMoveHandler=function(t){var e=t.coordinate;if(C(e,this.points[this.points.length-1])<1e-4)return!1;if(this.plot.freehand)this.points.push(e),this.plot.setPoints(this.points);else{var n=this.points.concat([e]);this.plot.setPoints(n)}},e.removeEventHandlers=function(){this.map.un("click",this.mapFirstClickHandler),this.map.un("click",this.mapNextClickHandler),this.map.un("pointermove",this.mapMouseMoveHandler),this.map.un("dblclick",this.mapDoubleClickHandler)},e.drawEnd=function(t){this.dispatchSync("drawEnd",{type:"drawEnd",originalEvent:t,feature:this.feature}),this.feature&&this.options.isClear&&this.drawLayer.getSource().removeFeature(this.feature),this.disActive()},e.addFeature=function(){this.feature=new c(this.plot),this.feature&&this.drawLayer&&this.drawLayer.getSource().addFeature(this.feature)},e.deactiveMapTools=function(){var e=this;this.map.getInteractions().getArray().every(function(t){return!(t instanceof o.DoubleClickZoom)||(e.dblClickZoomInteraction=t,e.map.removeInteraction(t),!1)})},e.activateMapTools=function(){this.dblClickZoomInteraction&&this.dblClickZoomInteraction instanceof o.DoubleClickZoom&&(this.map.addInteraction(this.dblClickZoomInteraction),this.dblClickZoomInteraction=null)},t}(m),ce=function(n){function t(t){var e;if(e=n.call(this)||this,!(t&&t instanceof l.Map))throw new Error("传入的不是地图对象！");return e.map=t,e.mapViewport=e.map.getViewport(),e.activePlot=null,e.startPoint=null,e.ghostControlPoints=null,e.controlPoints=null,e.mouseOver=!1,e.elementTable={},e.activeControlPointId=null,e.mapDragPan=null,e.previousCursor_=null,U(["controlPointMouseDownHandler","controlPointMouseMoveHandler2","controlPointMouseUpHandler","controlPointMouseMoveHandler","plotMouseOverOutHandler","plotMouseDownHandler","plotMouseUpHandler","plotMouseMoveHandler"],v(e)),e}h(t,n);var e=t.prototype;return e.initHelperDom=function(){var i=this;if(!this.map||!this.activePlot)return!1;var t=this.getMapParentElement();if(!t)return!1;var o=function(t,e,n){var i=document.createElement(t);return i.style.display="none",n&&(i.id=n),e&&e.appendChild(i),i}("div",t,W),e=this.getControlPoints();e&&Array.isArray(e)&&0<e.length&&e.forEach(function(t,e){var n=R+"-"+e;!function(t,e,n,i){var o=document.createElement(t);o.className=e||"",i&&(o.id=i),n&&n.appendChild(o)}("div",R,o,n),i.elementTable[n]=e})},e.getMapParentElement=function(){var t=this.map.getTargetElement();return!!t&&t.parentNode},e.destroyHelperDom=function(){var i=this;this.controlPoints&&Array.isArray(this.controlPoints)&&0<this.controlPoints.length&&(this.controlPoints.forEach(function(t,e){t&&t instanceof l.Overlay&&i.map.removeOverlay(t);var n=Z(R+"-"+e);n&&(et(n,"mousedown",i.controlPointMouseDownHandler.bind(i)),et(n,"mousemove",i.controlPointMouseMoveHandler2.bind(i)))}),this.controlPoints=[]);var t=this.getMapParentElement(),e=Z(W);e&&t&&function(t){var e=t.parentNode;e&&e.removeChild(t)}(e)},e.initControlPoints=function(){var r=this;this.controlPoints=[];var s=this.getControlPoints();s&&Array.isArray(s)&&0<s.length&&s.forEach(function(t,e){var n=R+"-"+e;r.elementTable[n]=e;var i=Z(n),o=new l.Overlay({id:n,position:s[e],positioning:"center-center",element:i});r.controlPoints.push(o),r.map.addOverlay(o),r.map.render(),tt(i,"mousedown",r.controlPointMouseDownHandler),tt(i,"mousemove",r.controlPointMouseMoveHandler2)})},e.controlPointMouseMoveHandler2=function(t){t.stopImmediatePropagation()},e.controlPointMouseDownHandler=function(t){this.activeControlPointId=t.target.id,this.map.on("pointermove",this.controlPointMouseMoveHandler),tt(this.mapViewport,"mouseup",this.controlPointMouseUpHandler)},e.controlPointMouseMoveHandler=function(t){var e=t.coordinate;if(this.activeControlPointId){var n=this.activePlot.getGeometry(),i=this.elementTable[this.activeControlPointId];n.updatePoint(e,i);var o=this.map.getOverlayById(this.activeControlPointId);o&&o.setPosition(e)}},e.controlPointMouseUpHandler=function(t){this.map.un("pointermove",this.controlPointMouseMoveHandler),et(this.mapViewport,"mouseup",this.controlPointMouseUpHandler)},e.activate=function(t){var e=this;t&&t instanceof c&&t.get("isPlot")&&t.getGeometry().isPlot&&t!==this.activePlot&&(this.deactivate(),this.activePlot=t,this.previousCursor_=this.map.getTargetElement().style.cursor,window.setTimeout(function(){e.dispatch("active_plot_change",e.activePlot)},500),this.map.on("pointermove",this.plotMouseOverOutHandler),this.initHelperDom(),this.initControlPoints())},e.getControlPoints=function(){var t=[];if(this.activePlot){var e=this.activePlot.getGeometry();e&&(t=e.getPoints())}return t},e.plotMouseOverOutHandler=function(t){var e=this.map.forEachFeatureAtPixel(t.pixel,function(t){return t});return e&&e===this.activePlot?this.mouseOver||(this.mouseOver=!0,this.map.getTargetElement().style.cursor="move",this.map.on("pointerdown",this.plotMouseDownHandler)):this.mouseOver&&(this.mouseOver=!1,this.map.getTargetElement().style.cursor="default",this.map.un("pointerdown",this.plotMouseDownHandler)),e},e.plotMouseDownHandler=function(t){this.ghostControlPoints=this.getControlPoints(),this.startPoint=t.coordinate,this.disableMapDragPan(),this.map.on("pointerup",this.plotMouseUpHandler),this.map.on("pointerdrag",this.plotMouseMoveHandler)},e.plotMouseMoveHandler=function(t){var e=t.coordinate[0]-this.startPoint[0],n=t.coordinate[1]-this.startPoint[1],i=[];if(this.ghostControlPoints&&Array.isArray(this.ghostControlPoints)&&0<this.ghostControlPoints.length)for(var o=0;o<this.ghostControlPoints.length;o++){var r=[this.ghostControlPoints[o][0]+e,this.ghostControlPoints[o][1]+n];i.push(r);var s=R+"-"+o,a=this.map.getOverlayById(s);a&&(a.setPosition(r),a.setPositioning("center-center"))}this.activePlot.getGeometry().setPoints(i)},e.plotMouseUpHandler=function(t){this.enableMapDragPan(),this.map.un("pointerup",this.plotMouseUpHandler),this.map.un("pointerdrag",this.plotMouseMoveHandler)},e.disconnectEventHandlers=function(){this.map.un("pointermove",this.plotMouseOverOutHandler),this.map.un("pointermove",this.controlPointMouseMoveHandler),et(this.mapViewport,"mouseup",this.controlPointMouseUpHandler),this.map.un("pointerdown",this.plotMouseDownHandler),this.map.un("pointerup",this.plotMouseUpHandler),this.map.un("pointerdrag",this.plotMouseMoveHandler)},e.deactivate=function(){this.activePlot=null,this.mouseOver=!1,this.map.getTargetElement().style.cursor=this.previousCursor_,this.previousCursor_=null,this.destroyHelperDom(),this.disconnectEventHandlers(),this.enableMapDragPan(),this.elementTable={},this.activeControlPointId=null,this.startPoint=null},e.disableMapDragPan=function(){var e=this;this.map.getInteractions().getArray().every(function(t){return!(t instanceof o.DragPan)||(e.mapDragPan=t,e.map.removeInteraction(t),!1)})},e.enableMapDragPan=function(){this.mapDragPan&&this.mapDragPan instanceof o.DragPan&&(this.map.addInteraction(this.mapDragPan),this.mapDragPan=null)},t}(m);ne.prototype._getRegularShape=function(t){try{return new u.RegularShape({fill:this._getFill(t.fill)||void 0,points:"number"==typeof t.points?t.points:1,radius:"number"==typeof t.radius?t.radius:void 0,radius1:"number"==typeof t.radius1?t.radius1:void 0,radius2:"number"==typeof t.radius2?t.radius2:void 0,angle:"number"==typeof t.angle?t.angle:0,snapToPixel:"boolean"!=typeof t.snapToPixel||t.snapToPixel,stroke:this._getStroke(t.stroke)||void 0,rotation:"number"==typeof t.rotation?t.rotation:0,rotateWithView:"boolean"==typeof t.rotateWithView&&t.rotateWithView,atlasManager:t.atlasManager?t.atlasManager:void 0})}catch(t){console.log(t)}},ne.prototype._getImage=function(t){try{return"icon"===(t=t||{}).type?this._getIcon(t.image):this._getRegularShape(t.image)}catch(t){console.log(t)}},ne.prototype._getIcon=function(t){try{return t=t||{},new u.Icon({anchor:t.imageAnchor?t.imageAnchor:[.5,.5],anchorXUnits:t.imageAnchorXUnits?t.imageAnchorXUnits:"fraction",anchorYUnits:t.imageAnchorYUnits?t.imageAnchorYUnits:"fraction",anchorOrigin:t.imageAnchorOrigin?t.imageAnchorYUnits:"top-left",color:t.imageColor?t.imageColor:void 0,crossOrigin:t.crossOrigin?t.crossOrigin:void 0,img:t.img?t.img:void 0,offset:t.offset&&Array.isArray(t.offset)&&2===t.offset.length?t.offset:[0,0],offsetOrigin:t.offsetOrigin?t.offsetOrigin:"top-left",scale:"number"==typeof t.scale?t.scale:1,snapToPixel:"boolean"!=typeof t.snapToPixel||t.snapToPixel,rotateWithView:"boolean"==typeof t.rotateWithView&&t.rotateWithView,opacity:"number"==typeof t.imageOpacity?t.imageOpacity:1,rotation:"number"==typeof t.imageRotation?t.imageRotation:0,size:t.size&&Array.isArray(t.size)&&2===t.size.length?t.size:void 0,imgSize:t.imgSize&&Array.isArray(t.imgSize)&&2===t.imgSize.length?t.imgSize:void 0,src:t.imageSrc?t.imageSrc:void 0})}catch(t){console.log(t)}},ne.prototype._getStroke=function(t){try{return t=t||{},new u.Stroke({color:t.strokeColor?t.strokeColor:void 0,lineCap:t.strokeLineCap&&"string"==typeof t.strokeLineCap?t.strokeLineCap:"round",lineJoin:t.strokeLineJoin&&"string"==typeof t.strokeLineJoin?t.strokeLineJoin:"round",lineDash:t.strokeLineDash?t.strokeLineDash:void 0,lineDashOffset:"number"==typeof t.strokeLineDashOffset?t.strokeLineDashOffset:"0",miterLimit:"number"==typeof t.strokeMiterLimit?t.strokeMiterLimit:10,width:"number"==typeof t.strokeWidth?t.strokeWidth:void 0})}catch(t){console.log(t)}},ne.prototype._getText=function(t){try{return new u.Text({font:t.textFont&&"string"==typeof t.textFont?t.textFont:"10px sans-serif",offsetX:"number"==typeof t.textOffsetX?t.textOffsetX:0,offsetY:"number"==typeof t.textOffsetY?t.textOffsetY:0,scale:"number"==typeof t.textScale?t.textScale:void 0,rotation:"number"==typeof t.textRotation?t.textRotation:0,text:t.text&&"string"==typeof t.text?t.text:void 0,textAlign:t.textAlign&&"string"==typeof t.textAlign?t.textAlign:"start",textBaseline:t.textBaseline&&"string"==typeof t.textBaseline?t.textBaseline:"alphabetic",rotateWithView:"boolean"==typeof t.rotateWithView&&t.rotateWithView,fill:this._getFill(t.textFill),stroke:this._getStroke(t.textStroke)})}catch(t){console.log(t)}},ne.prototype._getFill=function(t){try{return t=t||{},new u.Fill({color:t.fillColor?t.fillColor:void 0})}catch(t){console.log(t)}};var pe,ge=((pe=fe.prototype).getBaseStyle=function(t){var e=t.getStyle();if(!e){var n=j(this.map,this.layerName);if(!(n&&n instanceof s.Vector))return!1;e=n.getStyle()}return e},pe.setIcon=function(t,e){try{if(t&&t instanceof c){var n=this.getBaseStyle(t).clone(),i=this._getImage(e);i&&(n.setImage(i),t.setStyle(n))}}catch(t){console.warn(t)}},pe.setBackgroundColor=function(t,e){try{if(t&&t instanceof c){var n=this.getBaseStyle(t).clone(),i=n.getFill(),o=i.getColor();if(o){var r=f.asArray(o),s=f.asArray(e),a=this.handleBackgroundColor(s,r[3]);i.setColor(a),t.setStyle(n)}}}catch(t){console.warn(t)}},pe.setOpacity=function(t,e){try{if(t&&t instanceof c){var n=this.getBaseStyle(t);if(n){var i=n.clone(),o=i.getFill(),r=o.getColor();if(r){var s=f.asArray(r);s[3]=e;var a="rgba("+s.join(",")+")";o.setColor(a),t.setStyle(i)}}}}catch(t){console.warn(t)}},pe.setBorderColor=function(t,e){try{if(t&&t instanceof c){var n=this.getBaseStyle(t).clone();n.getStroke().setColor(e),t.setStyle(n)}}catch(t){console.warn(t)}},pe.setBorderWidth=function(t,e){try{if(t&&t instanceof c){var n=this.getBaseStyle(t).clone();n.getStroke().setWidth(e),t.setStyle(n)}}catch(t){console.warn(t)}},pe.handleBackgroundColor=function(t,e){try{e=e||1;var n=f.asArray(t);return n[3]=e,"rgba("+n.join(",")+")"}catch(t){console.warn(t)}},pe.getColor=function(t){try{var e=f.asArray(t);return f.asString(e)}catch(t){console.warn(t)}},pe.fixObject=function(t){if(t&&"object"==typeof t)for(var e in t)e&&void 0===t[e]&&delete t[e];return t},pe.getStroke_=function(t){var e=null;if(t){var n=t.getStroke();n&&((e={}).strokeColor=this.getColor(n.getColor()),e.strokeWidth=n.getWidth(),e.strokeLineDash=n.getLineDash(),e.lineDashOffset=n.getLineDashOffset(),e.strokeLineCap=n.getLineCap(),e.strokeLineJoin=n.getLineJoin(),e.strokeMiterLimit=n.getMiterLimit())}return this.fixObject(e)},pe.getFill_=function(t){var e=null;if(t){var n=t.getFill();if(n){e={};var i=n.getColor();e.fillColor=this.getColor(i)}}return this.fixObject(e)},pe.getText_=function(t){var e=null;if(t){var n=t.getText();n&&((e={}).textFont=n.getFont(),e.textOffsetX=n.getOffsetX(),e.textOffsetY=n.getOffsetY(),e.textScale=n.getScale(),e.textRotation=n.getRotation(),e.text=n.getText(),e.textAlign=n.getTextAlign(),e.textBaseline=n.getTextBaseline(),e.rotateWithView=n.getRotateWithView(),e.textFill=this.getFill_(n),e.textStroke=this.getStroke_(n))}return this.fixObject(e)},pe.getImage_=function(t){var e=null;if(t){var n=t.getImage();n&&(e={},n instanceof u.Icon?(e.type="icon",e.image={},e.image.imageAnchor=n.getAnchor(),e.image.imageColor=n.getColor(),e.image.imageSrc=n.getSrc(),e.image.imgSize=n.getSize(),e.image.scale=n.getScale(),e.image.imageRotation=n.getRotation(),e.image.rotateWithView=n.getRotateWithView(),e.image.imageOpacity=n.getOpacity(),e.image.snapToPixel=n.getSnapToPixel(),e.image.offset=n.getOrigin()):n instanceof u.RegularShape&&(e.type="",e.image={},e.image.fill=this.getFill_(n),e.image.points=n.getPoints(),e.image.radius=n.getRadius(),e.image.radius2=n.getRadius2(),e.image.angle=n.getAngle(),e.image.stroke=this.getStroke_(n),e.image.rotateWithView=n.getRotateWithView(),e.image.snapToPixel=n.getSnapToPixel()))}return this.fixObject(e)},pe.getStyleCode=function(t){try{if(t&&t instanceof c){var e=this.getBaseStyle(t);if(e&&e instanceof u.Style){var n=this.getFill_(e),i=[1,null],o=i[0],r=i[1],s=i[2];n&&n.fillColor&&(r=f.asArray(n.fillColor),o=parseFloat(r[3]),r&&"number"==typeof o&&(s=this.handleBackgroundColor(f.asString(r),o)));var a=this.getStroke_(e),h=this.getText_(e);return{fill:{fillColor:s,opacity:o},stroke:a,image:this.getImage_(e),text:h}}}}catch(t){console.warn(t)}},pe.removeAllFeatures=function(){var t=j(this.map,this.layerName),e=this.map.getOverlays().getArray();if(t&&t.getSource().clear(),e&&0<e.length)for(var n=e.length,i=0;i<n;i++)e[i]&&e[i].get("isPlotText")&&(this.map.removeOverlay(e[i]),i--)},pe.getFeatures=function(){var n=this,i=[],t=j(this.map,this.layerName);if(t){var e=t.getSource();if(e&&e instanceof p.Vector){var o=e.getFeatures();o&&0<o.length&&o.forEach(function(t,e){t&&t.getGeometry&&i.push(n.jsonFeature(t))})}}return this.map.getOverlays().getArray().forEach(function(t){if(t.get("isPlotText")){var e=t.getStyle();e.width=t.getWidth()+"px",e.height=t.getHeight()+"px",i.push({type:"Feature",geometry:{type:"PlotText",coordinates:t.getPosition()},properties:{id:t.getId(),width:t.getWidth(),height:t.getHeight(),style:e,value:t.getValue()}})}}),i},pe.jsonFeature=function(t){var e,n=t.getGeometry();return n&&n.getCoordinates&&(e={type:"Feature",geometry:{type:n.getType(),coordinates:n.getCoordinates()},properties:{type:t.getGeometry().getPlotType(),style:this.getStyleCode(t),points:t.getGeometry().getPoints()}}),e},pe.addFeatures=function(t,r){var s=this;if(t&&Array.isArray(t)&&0<t.length){var e=j(this.map,this.layerName);if(e||(e=q(this.map,this.layerName,{create:!0})).setZIndex(this.options.zIndex||99),e){var a=e.getSource();if(a&&a instanceof p.Vector){var h=[];if(t.forEach(function(t,e){if(t&&t.geometry&&"PlotText"!==t.geometry.type)if(t.properties.type&&le[t.properties.type]){var n=new c({geometry:new le[t.properties.type]([],t.properties.points,t.properties)});if(n.set("isPlot",!0),h.push(n.getGeometry().getExtent()),t.properties.style){var i=new ne(t.properties.style);i&&n.setStyle(i)}r(n,e),a.addFeature(n)}else console.warn("不存在的标绘类型！");else if(t&&t.geometry&&"PlotText"===t.geometry.type){h.push(new g.Point(t.geometry.coordinates).getExtent());var o=new rt({id:t.properties.id,position:t.geometry.coordinates,width:t.properties.width,height:t.properties.height,value:t.properties.value,style:t.properties.style});s.map&&s.map instanceof l.Map&&o?(r(o,e),s.map.addOverlay(o)):console.warn("未传入地图对象或者plotText创建失败！")}}),this.options.zoomToExtent&&h&&0<h.length){var n=this._getExtent(h),i=this.map.getSize(),o=this.map.getView();o.fit(n,{size:i,duration:800,maxZoom:o.getMaxZoom()||void 0})}}}}},pe._getExtent=function(t,e){void 0===e&&(e={});var n=[Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY],i=t.reduce(function(t,e){return[Math.min(e[0],t[0]),Math.min(e[1],t[1]),Math.max(e[2],t[2]),Math.max(e[3],t[3])]},n),o=d.getSize(i),r="number"==typeof e.adjust?e.adjust:.2,s="number"==typeof e.minWidth?e.minWidth:.05,a="number"==typeof e.minHeight?e.minHeight:.05;if(o[0]<=s||o[1]<=a){var h=d.getBottomLeft(i),l=d.getTopRight(i),u=h[0]-r,c=h[1]-r,p=l[0]+r,g=l[1]+r;i=d.buffer([u,c,p,g],r)}return i},fe);function fe(t,e){if(!(t&&t instanceof l.Map))throw new Error("传入的不是地图对象！");this.map=t,this.options=e,this.layerName=this.options&&this.options.layerName?this.options.layerName:N}function de(t,e){this.plotDraw=new ue(t,e),this.plotEdit=new ce(t,e),this.plotUtils=new ge(t,e)}return t(de,"PlotTypes",Dt),t(de,"Geometry",le),de});
